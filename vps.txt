# VPS Hosting Guide (Noob Friendly)

This guide hosts **backend + frontend + database** on one VPS and uses your **Cloudflare domain**.

---
## ✅ IMPORTANT: Do you need 1 domain or 2?
You have **two valid options**. Choose **ONE**:

**Option A (Simpler, 1 domain)**
- Frontend: `https://yourdomain.com`
- Backend: `https://yourdomain.com/api/v1`
- Cloudflare DNS: **ONE A record** → your VPS IP

**Option B (Separate API subdomain)**
- Frontend: `https://yourdomain.com`
- Backend: `https://api.yourdomain.com/api/v1`
- Cloudflare DNS: **TWO A records** → same VPS IP

If you are new, **choose Option A**.

---
## 1. Login to your VPS
```bash
ssh root@YOUR_SERVER_IP
```

---
## 2. Update system + install tools
```bash
apt update && apt upgrade -y
apt install -y git curl nginx ufw
```

Enable firewall (safe):
```bash
ufw allow OpenSSH
ufw allow "Nginx Full"
ufw enable
```

---
## 3. Install Node.js + PM2 + PostgreSQL
```bash
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
apt install -y nodejs
npm install -g pm2
apt install -y postgresql postgresql-contrib
```

---
## 4. Create database
```bash
sudo -u postgres psql
```
In the Postgres shell, paste:
```sql
CREATE DATABASE amak_prod;
CREATE USER amak_user WITH PASSWORD 'StrongPassword123';
GRANT ALL PRIVILEGES ON DATABASE amak_prod TO amak_user;
\q
```

Your DB connection string will be:
```
postgresql://amak_user:StrongPassword123@localhost:5432/amak_prod
```

---
## 5. Clone the project
```bash
mkdir -p /var/www && cd /var/www
git clone https://github.com/Loveago/amak.git
cd amak
```

---
## 6. Backend setup
```bash
cd backend
cp .env.example .env
nano .env
```
Fill `.env` with your real secrets. Make sure:
- `DATABASE_URL` = the Postgres string above
- `BASE_URL` = `https://yourdomain.com`

Install + migrate + seed:
```bash
npm install
npm run prisma:generate
npx prisma migrate deploy
npm run prisma:seed
```

Start backend:
```bash
pm2 start src/server.js --name amak-backend
pm2 save
```

---
## 7. Frontend setup
```bash
cd ../frontend
```

Create frontend env file:
```bash
nano .env.local
```

Set `NEXT_PUBLIC_API_URL` based on your chosen option:
- **Option A:**
  ```
  NEXT_PUBLIC_API_URL=https://yourdomain.com/api/v1
  ```
- **Option B:**
  ```
  NEXT_PUBLIC_API_URL=https://api.yourdomain.com/api/v1
  ```

Build + start frontend:
```bash
npm install
npm run build
pm2 start npm --name amak-frontend -- start
pm2 save
```

---
## 8. Cloudflare DNS
Go to your Cloudflare DNS and create records:

**Option A (one domain):**
- A record: `yourdomain.com` → VPS IP

**Option B (two domains):**
- A record: `yourdomain.com` → VPS IP
- A record: `api.yourdomain.com` → VPS IP

Turn **orange cloud ON** (proxy enabled).

---
## 9. Nginx configuration
Create config file:
```bash
nano /etc/nginx/sites-available/amak.conf
```

### ✅ Option A (one domain)
```nginx
server {
  server_name yourdomain.com;

  location /api/ {
    proxy_pass http://127.0.0.1:5000/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
  }

  location / {
    proxy_pass http://127.0.0.1:3000/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
  }
}
```

### ✅ Option B (two domains)
```nginx
server {
  server_name api.yourdomain.com;
  location / {
    proxy_pass http://127.0.0.1:5000/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
  }
}

server {
  server_name yourdomain.com;
  location / {
    proxy_pass http://127.0.0.1:3000/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
  }
}
```

Enable config:
```bash
ln -s /etc/nginx/sites-available/amak.conf /etc/nginx/sites-enabled/
nginx -t
systemctl reload nginx
```

---
## 10. SSL (HTTPS)
```bash
apt install -y certbot python3-certbot-nginx
```

Run certbot:
- **Option A:**
  ```bash
  certbot --nginx -d yourdomain.com
  ```
- **Option B:**
  ```bash
  certbot --nginx -d yourdomain.com -d api.yourdomain.com
  ```

Follow prompts and allow HTTPS redirect.

---
## 11. Cloudflare SSL setting
In Cloudflare ➜ SSL/TLS:
- Set mode to **Full** (or **Full (Strict)** if certbot is installed).

---
## 12. Test everything
1. Open `https://yourdomain.com` (frontend should load).
2. Open `https://yourdomain.com/api/v1` (or `https://api.yourdomain.com/api/v1`).
3. Try a checkout flow to confirm payments.
4. Check PM2:
   ```bash
   pm2 status
   ```

---
## 13. Future updates (deploy new code)
```bash
cd /var/www/amak
git pull origin main
cd backend && npm install && pm2 restart amak-backend
cd ../frontend && npm install && npm run build && pm2 restart amak-frontend
```

---
✅ You’re done. If you want the **simplest setup**, use **Option A**.
